<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VueTube</title>
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
    <link href="bootstrap/bootstrap-5.3.0.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="bootstrap/bootstrap-5.3.0.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <script
            src="bootstrap/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous">
    </script>
</head>
<body>
<br>
<div class="container">

    <div id="header"></div>
    <div id="test1"></div>

    <div class="row" id="results">
        <img id="loadingGIF" src="static/loading.gif">
    </div>

    <div id="footer"></div>

</div>
</body>


<script>

    //TODO https://api.datamuse.com/words?sp=b*&max=10 autocomplete api
    // with this api, words on the searchbar will appear as autocomplete

    // load header and footer so its not hard coded on every view
    $(function () {
        $("#footer").load("footer.html");
        $("#header").load("header.html");
    });

    function call(query) {
        document.getElementById('searchInput').blur()
        var search = document.getElementById('searchInput').value
        if (query != undefined)
            search = query
        if (search == undefined || search == "")
            return

        // set main view to loading screen
        document.getElementById("results").innerHTML = '<img id="loadingGIF" src="static/loading.gif">'


        // get query parameters if they exist
        const urlParams = new URLSearchParams(window.location.search);
        const searchQ = urlParams.get('q');
        if (searchQ != null) {
            search = searchQ
            document.getElementById('searchInput').value = searchQ
        }


        // Make an HTTP GET request to the YouTube Data API search endpoint
        var apiKey = ""
        var apiKey1 = 'AIzaSyB5LG4TFaO95eqkE6yRBgJgr0egwSBSy8U'
        var apiKey2 = 'AIzaSyD1HX-in66XEtm57Ig6S2JJDQ56uXr5c2s'
        var apiKey3 = 'AIzaSyAdv9_oNyCgRE_coy3QYLlIG05bBqznx80'
        var num = Math.random()
        if (num < 0.33)
            apiKey = apiKey1
        else if (num < 0.66)
            apiKey = apiKey2
        else apiKey = apiKey3
        var q = []
        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${search}&key=${apiKey}&maxResults=20`) // maxResults=50
            .then(response => response.json())
            .then(data => {
                console.log(data)
                // Iterate over the retrieved videos and assign properties for each item
                data.items.forEach((item, i) => {
                    var obj = { // every item
                        isChannel: false,
                        title: item.snippet.title,
                        thumbnailUrl: item.snippet.thumbnails.high.url,
                        publishedAt: item.snippet.publishedAt
                    }
                    if (item.id.kind === "youtube#channel") { // if item is channel
                        obj.isChannel = true
                        obj.channelURL = `https://www.youtube.com/channel/${item.id.channelId}`
                        obj.publishedAt = 'Channel'
                    } else { // if item is video
                        obj.live = item.snippet.liveBroadcastContent
                        obj.watch = item.id.videoId
                        obj.videoURL = `https://www.youtube.com/watch?v=${item.id.videoId}`;
                        obj.channelURL = `https://www.youtube.com/channel/${item.snippet.channelId}`
                        obj.chTitle = item.snippet.channelTitle;
                    }
                    // store only channels and valid videos (non-null watchID)
                    if (obj.isChannel || (!obj.isChannel && obj.watch !== undefined)) {
                        q.push(obj)
                    }

                });
            })
            .catch(error => {
                console.error('Error:', error);
            });

        // create div objects ( in the implemented code the divs are hard coded)
        // TODO: in the following example, the divs are created correctly
        // ----------------------------------------------------
        // var box = document.createElement("div")
        // box.id = 'boxID'
        // document.body.querySelector("#test1").appendChild(box)
        // ----------------------------------------------------
        setTimeout(function () {
            text = ""
            for (let x in q) {
                var vidLink = ""
                var end = ""
                var isVideo = ""
                var chLink = ""
                var openVideo = "view.html?watch=" + q[x].watch
                var d = q[x].publishedAt.slice(0, 10)
                var publishedAt = d
                if (d!='Channel')
                    publishedAt = d.slice(8,10) + '.' + d.slice(5,7) + '.' + d.slice(0,4)
                if (q[x].live == 'live')
                    publishedAt = '<span class="live">Live</span>'
                if (!q[x].isChannel) {
                    openVideo += "&title=" + q[x].title + "&channelName=" + q[x].chTitle
                    isVideo = 'Channel: <a class="text-decoration-none " target="_blank" href="' + q[x].channelURL + '">' + q[x].chTitle + '</a>'
                    vidLink = '<a class="text-decoration-none " href="' + openVideo + '">' //q[x].videoURL
                    end = "</a>"
                } else {
                    chLink = '<a class="text-decoration-none " target="_blank" href=" ' + q[x].channelURL + '">'
                    end = "</a>"
                }


                text += '<div class="col mb-4">\n' +
                    '            <div class="card" style="width: 18rem;">\n' +
                    '                ' + vidLink + '<img src="' + q[x].thumbnailUrl + '" class="card-img-top" alt="...">' + end + '\n' +
                    '                <div class="card-body cb-1">\n' +
                    '<div>' +
                    '                    ' + vidLink + chLink + '<h5 class="card-title">' + q[x].title + '</h5>' + end + '\n' +
                    isVideo +
                    '</div>' +
                    '                    <p class="card-text text-end">' + publishedAt + '</p>\n' +
                    '                </div>\n' +
                    '            </div>\n' +
                    '        </div>'


                document.getElementById("results").innerHTML = text

            }

            // error prevention timeout call if last one didnt succeed
            setTimeout(() => {
                if (document.getElementById("results").innerHTML === '<img id="loadingGIF" src="static/loading.gif">') {
                    console.log("calling with q: " + search)
                    call(search)
                }
            }, 1500)

        }, 800)
    }


    // search button click call but with 100ms delay
    setTimeout(() => {
        document.getElementById("bt1").onclick = function () {
            call()
        }
    }, 100)


    // Enter key usage instead of clicking search button with mouse
    function focusFunc() {
        var input = document.getElementById("searchInput");
        input.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                call()
            }
        });
    }


    // initial call on first view
    setTimeout(() => {
        call("programming")
    }, 200)




</script>
<style>

    .col {
        text-align: -moz-center;
        text-align: -webkit-center;
    }

    .card {
        text-align: left;
        height: 100%;
    }

    .green {
        color: #42b883;
    }

    .cb-1 {
        display: flex;
        justify-content: space-between;
        flex-direction: column;
    }

    #loadingGIF {
        width: 100px;
        margin-left: auto;
        margin-right: auto;
    }
    .live{
        font-weight: bold;
        border: 2px solid;
        color: red;
        padding: 5px 10px 5px 10px;
        border-radius: 10px;
    }
</style>
</html>

